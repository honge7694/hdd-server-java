# E-commerce 플랫폼 MSA 전환을 위한 서비스 설계 제안서

## 1. 서비스 설계
| 서비스 명  | 주요 책임               | 관리 데이터                  |
|-------------|------------------------|-------------------------------|
| 사용자 서비스 (User Service) | - 회원 가입, 인증 및 인가<br>- 사용자 프로필 및 주소록 관리 | - 사용자 정보<br>- 주소        |
| 상품 서비스 (Product Service) | - 상품 정보 관리<br>- 재고 관리<br>- 상품 가격 정보 관리 | - 상품 상세<br>- 카테고리<br>- 재고 수량 |
| 주문 서비스 (Order Service) | - 주문 생성 및 주문 내역 관리<br>- 주문 프로세스 조정 | - 주문 정보<br>- 주문 상품<br>- 배송 정보 |
| 쿠폰 서비스 (Coupon Service) | - 쿠폰 발급 및 관리<br>- 쿠폰 유효성 검증 및 사용 처리 | - 쿠폰 정보<br>- 사용자별 쿠폰 보유 내역 |
| 결제 서비스 (Payment Service) | - 외부 PG사 연동을 통한 결제 처리<br>- 결제 성공/실패 이력 관리 | - 결제 트랜잭션 정보            |


## 2. 분산 트랜잭션 설계

### 성공 흐름
1. **Order Service**
   - 1-1. 클라이언트로부터 주문 요청(상품 ID, 수량, 쿠폰ID)을 받습니다.
   - 1-2. 트랜잭션 시작: 주문 데이터를 생성 후 OUTBOX 테이블에 OrderCreated 이벤트 저장 후 커밋합니다.
   - 1-3. OrderCreated 이벤트를 발행합니다.
2. **Coupon Service**
   - 2-1. OrderCreated 이벤트를 구독합니다.
   - 2-2. 트랜잭션 시작: 쿠폰의 상태를 USED로 변경 후, OUTBOX 테이블에 CouponUsed 이벤트를 저장합니다.
   - 2-3. 커밋 후 CouponUsed 이벤트를 발행합니다.
3. **Product Service**
    - 3-1. CouponUsed 이벤트를 구독합니다.
    - 3-2. 트랜잭션 시작: 재고를 차감하고, OUTBOX 테이블에 StockDecremented 이벤트를 저장합니다.
    - 3-3. 커밋 후 StockDecremented 이벤트를 발행합니다.
4. **Payment Service**
    - 4-1. StockDecremented 이벤트를 구독합니다.
    - 4-2. 결제를 성공하면 paymentCompleted 이벤트를 발행합니다.
5. **Order Service**
    - 5-1. PaymentCompleted 이벤트를 구독합니다.
    - 5-2. 주문 상태를 Completed로 저장합니다.

### 실패 흐름
- 3-2. 단계에서 Product Service가 재고 부족한 경우
  - OUTBOX 테이블에 StockUnavailable 실패 이벤트를 저장합니다.
  - CouponService는 StockUnavailable 이벤트를 구독하여, 보상 트랜잭션을 실행합니다. (사용한 쿠폰을 다시 가능한 상태로 변경)
  - OrderService는 StockUnavailable 이벤트를 구독하여, 주문 상태를 FAILED로 변경합니다.

## 3. 분산 트랜잭션 처리의 한계와 해결방안

### 분산 환경에서의 트랜잭션 한계
- **원자성 붕괴**
  - 여러 서비스를 하나의 비즈니스 로직(주문)으로 트랜잭션을 묶을 수 없습니다. 결제 서비스에서 재고는 차감이 되었지만, 돈이 결제가 안되면 데이터가 불일치 하게 됩니다.
- **일관성 제약**
  - 모든 트랜잭션이 성공적으로 완료된 시점에는 일관성이 유지가 되지만, 중간 과정에서는 일시적으로 데이터가 불일치할 수 있습니다.
- **복잡성 증가**
  - 트랜잭션 실패 시, 서비스가 저장한 작업을 되돌리는 보상 트랜잭션 로직을 구현해야합니다.

### 해결 방안(Saga 패턴)
이전에 성공한 서비스들을 보상 트랜잭션을 통해 작업을 취소하는 패턴입니다.

1. **코레오그래피**
   - 설명: 각 서비스가 메시지 브로커를 통해 이벤트를 발행하고 다른 서비스가 구독하여 서비스를 수행합니다.
   - 장점: 서비스 간의 결합도가 낮고, 추가가 용이합니다.
   - 단점: 흐름 파악하기 어렵고, 순환 의존성이 발생할 수 있어 디버깅이 복잡해질 수 있습니다.
2. **오케스트레이션**

   - 설명: 중앙 조정자 서비스가 전체 비즈니스 프로세스의 흐름을 관리하고, 작업을 명시적으로 요청하는 방식입니다. 오케스트라의 지휘자처럼 동작합니다.
   - 장점: 전체 프로세스를 중앙에서 관리되므로 흐름 파악 및 추적이 용이하며, 트랜잭션 관리가 단순합니다.
   - 단점: 서비스 간 결합도가 코레옥래피 방식보다 높아지고, 조정자에 대한 의존성이 높아집니다. 